# loki-googlesheets-sync

## 1. 概要

この Google Apps Script (GAS) プログラムは、Grafana Loki から指定された LogQL クエリに一致するログデータを取得し、ログ内の JSON フィールド `metric_name` の値に基づいて Google スプレッドシートの各シートに追記形式で記録します。JSON値はキーごとに分割して表形式で記録します。

Overlap 期間を設けて Loki からログを取得し、重複排除処理を行った上で新しいログのみをスプレッドシートに記録します。また、ログ内に新しいキーが出現した場合、スプレッドシートのヘッダー行を動的に更新します。タイムスタンプは、設定されたタイムゾーンオフセットを適用したナノ秒精度の ISO 8601 形式の文字列として記録されます。

このプロジェクトは `clasp` を使用して管理されることを想定しています。

## 2. 機能

* **Loki ログ取得**:
    * 設定された基本 LogQL クエリと時間範囲に基づき Loki からログを取得します。
    * 前回処理した最新タイムスタンプと Overlap 秒数を考慮して取得範囲を自動調整します。
    * Basic 認証または API キー (Bearer トークンなど) による Loki への認証に対応します。
* **スプレッドシートへの転記**:
    * 取得したログを、JSON 内の `metric_name` キーの値に基づき、対応する名前のシートに追記します。
    * `metric_name` に対応するシートが存在しない場合は自動的に作成します。
    * シート名が `_` で始まるシートは処理対象外です。
    * `metric_name` が存在しない、または許可されない文字を含むログはスキップされます。
* **データ処理**:
    * **タイムスタンプ**: Loki の Unix ナノ秒タイムスタンプを、設定されたタイムゾーンオフセット (`+HH:MM` 形式) でナノ秒精度の ISO 8601 文字列 (`YYYY-MM-DDTHH:mm:ss.nnnnnnnnn+HH:MM`) に変換して記録します。
    * **重複排除**: Overlap 期間を含めて取得したログとシート上の既存ログを比較し、完全に一致するログは書き込みません（ハッシュ比較を使用）。
    * **ヘッダー**: ログデータに新しいキーが出現した場合、該当シートのヘッダー行（1行目）の末尾に新しいキーを自動的に追加します。
    * **データ型**: 数値、真偽値はそのまま、配列やオブジェクトは JSON 文字列として記録します。欠損キーは空文字列になります。
* **エラーハンドリング**: 特定の `metric_name` の処理でエラーが発生しても、他の `metric_name` の処理を継続します。エラー詳細は GAS の実行ログまたは Cloud Logging (Stackdriver) に記録されます。

## 3. セットアップ・導入手順

### 3.1. 前提条件

* Node.js および npm (または yarn) がインストールされていること。
* `clasp` がインストールされていること (`npm install -g @google/clasp`)。
* Google アカウントを持っていること。
* Loki が稼働しており、API エンドポイント URL と認証情報が利用可能であること。
* ログを書き込む Google スプレッドシートが準備されていること（空のシートでOK）。

### 3.2. インストール

1.  **リポジトリのクローンまたはダウンロード**:
    ```bash
    git clone <repository-url>
    cd <repository-directory>
    ```
    または、ソースコードをダウンロードして展開します。

2.  **Google アカウントへのログイン**:
    ```bash
    clasp login
    ```
    ブラウザが開き、Google アカウントへのログインと `clasp` への権限付与を求められます。

3.  **GAS プロジェクトの作成または紐付け**:
    * **新規作成の場合**:
        ```bash
        clasp create-script --title "Loki GoogleSheets Sync" --rootDir ./src --type standalone
        git checkout -- src/appsscript.json
        ```
        作成されたスクリプト ID をメモしておきます。
    * **既存のスタンドアロンスクリプトに紐付ける場合**:
        ```bash
        clasp clone <scriptId> --rootDir ./src
        ```

4.  **ソースコードのデプロイ**:
    ```bash
    clasp push
    ```
    ローカルのコードが Google Apps Script プロジェクトにアップロードされます。

### 3.3. スクリプトプロパティの設定

スクリプトが動作するためには、以下の情報をスクリプトプロパティに設定する必要があります。

1.  Google Apps Script エディタを開きます (`clasp open`)。
2.  左側のメニューから「プロジェクトの設定」（歯車アイコン）をクリックします。
3.  「スクリプト プロパティ」セクションを見つけ、「スクリプト プロパティを編集」をクリックします。
4.  以下のキーと対応する値を**正確に**追加します。

    | キー                     | 説明                                                                                                                             | 例                                        | 必須 |
    | :----------------------- | :------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------- | :--- |
    | `SPREADSHEET_ID`         | ログを記録する Google スプレッドシートの ID。URL から取得できます (`.../d/SPREADSHEET_ID/edit`)。                                       | `12345abcdefghijklmnopqrstuvwxyz67890`    | ✔️   |
    | `LOKI_API_ENDPOINT`      | Loki のクエリ用 API エンドポイント URL (`/loki/api/v1` などを含まない)。                                                               | `https://your-loki.example.com` | ✔️   |
    | `LOKI_USERNAME`          | (オプション) Loki が Basic 認証を使用する場合のユーザー名。                                                                       | `myuser`                                  |      |
    | `LOKI_PASSWORD`          | (オプション) Loki が Basic 認証を使用する場合のパスワード。                                                                       | `mypassword`                              |      |
    | `LOKI_API_KEY`           | (オプション) Loki が Bearer トークンなどの API キー認証を使用する場合のキー。`LOKI_USERNAME`/`PASSWORD` とは排他的に使用します。        | `your-secret-api-key`                     |      |
    | `LOKI_BASE_QUERY`        | Loki からログを取得する際の基本的な LogQL クエリ (時間範囲を含まない)。                                                             | `{namespace="production", app="my-app"}`    | ✔️   |
    | `LOKI_QUERY_LIMIT`       | 1回の Loki へのクエリで取得する最大ログ件数。指定しない場合のデフォルトは `1000`。                                                    | `5000`                                    |      |
    | `LOKI_OVERLAP_SECONDS` | 前回取得した最新タイムスタンプから何秒遡って取得を開始するか。遅延到着ログのため。指定しない場合のデフォルトは `0` (Overlap なし)。     | `300` (5分)                               |      |
    | `TIMEZONE_OFFSET`        | スプレッドシートに記録するタイムスタンプの UTC からのオフセット (`+HH:MM` または `-HH:MM` 形式)。指定しない場合のデフォルトは `+00:00` (UTC)。 | `+09:00` (日本時間), `-05:00`               |      |

5.  「保存」をクリックします。

### 3.4. 権限の承認

初めてスクリプトを実行する際（または `clasp run` を使用する場合）、必要な権限の承認を求められます。画面の指示に従って承認してください。必要なスコープは `appsscript.json` に定義されています（スプレッドシート、外部接続、スクリプトプロパティ等）。

### 3.5. トリガーの設定 (定期実行)

スクリプトを定期的に自動実行するには、トリガーを設定します。

1.  GAS エディタの左側メニューから「トリガー」（時計アイコン）をクリックします。
2.  「トリガーを追加」ボタンをクリックします。
3.  以下の項目を設定します:
    * **実行する関数を選択**: `main`
    * **実行するデプロイを選択**: `Head` (通常はこれでOK)
    * **イベントのソースを選択**: `時間主導型`
    * **時間ベースのトリガーのタイプを選択**: `分タイマー`, `時タイマー`, `日タイマー` など、実行したい頻度を選択します。
    * **時間の間隔を選択**: （例: `15 分ごと`, `午前 1 時～ 2 時`）
    * **エラー通知設定**: 必要に応じて設定します（例: `毎日通知を受け取る`）。
4.  「保存」をクリックします。再度、権限の承認を求められる場合があります。

## 4. Loki 側の要件

* Loki から取得するログは **JSON 形式** である必要があります。スクリプトはログ行を JSON としてパースしようとします。
* 各 JSON ログには、シート名を決定するための **`metric_name`** キーが含まれている必要があります。
* `metric_name` の値は、英大文字、英小文字、数字、ハイフン (`-`)、アンダースコア (`_`) のみで構成されている必要があります。これ以外の文字が含まれるログ、または `metric_name` がないログは処理されません。

## 5. スプレッドシートの構造

* `metric_name` ごとにシートが作成されます。シート名は `metric_name` の値と一致します。
* 各シートの **1行目** は **ヘッダー行** となり、JSON ログのキー名が格納されます。
* **2行目以降** にログデータが記録されます。1行が1つのログに対応します。
* `timestamp` 列には、指定した `TIMEZONE_OFFSET` が適用されたナノ秒精度の ISO 8601 形式のタイムスタンプ文字列が記録されます (例: `2025-04-21T07:40:28.123456789+09:00`)。
* ログ内に対応するキーが存在しない場合、セルは空文字列 (`""`) になります。
* 数値と真偽値は対応するデータ型で記録されますが、配列やネストされたオブジェクトは JSON 文字列として記録されます。

## 6. 技術スタック

* Google Apps Script (GAS) - V8 Runtime
* clasp (Command Line Apps Script Projects)
* Google Sheets API (via SpreadsheetApp service)
* Loki LogQL & HTTP API

## 7. 制限事項

* **大量ログ**: このスクリプトは、比較的大量のログ（例: 1回の実行で数万件超）を処理するには不向きな場合があります。GAS の実行時間制限（通常 6分/実行）、メモリ制限、API 呼び出し回数制限の影響を受ける可能性があります。
* **重複排除の負荷**: シート内のデータ量や Overlap 期間によっては、重複排除のためのデータ読み込みと比較処理に時間がかかり、実行時間制限に達する可能性があります。
* **タイムスタンプ**:
    * ナノ秒精度および固定オフセットのタイムスタンプは文字列として記録されるため、スプレッドシートの標準的な日付/時刻関数やグラフ機能が期待通りに動作しない場合があります。
    * 時刻比較は内部的に UTC ナノ秒 (BigInt) に変換して行われます。
* **サマータイム非考慮**: `TIMEZONE_OFFSET` は固定です。サマータイム（夏時間）が導入されている地域で UTC 以外のオフセットを指定した場合、記録される時刻が実際の現地時刻とズレる期間が発生します。
* **設定変更の影響**: `TIMEZONE_OFFSET` を変更すると、過去のデータと新しいデータでオフセットが混在する可能性があります。分析時には UTC に正規化するなどの注意が必要です。

## 8. ライセンス

MIT License
